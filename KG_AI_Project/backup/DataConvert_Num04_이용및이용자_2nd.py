import pandas as pd
from openpyxl import load_workbook

# 기본통계_이용및이용자.xlsx 데이터시트 csv 파일 변환 스크립트 첫번째.
# 연도별 데이터시트 시작열 수정 코드

# 파일 경로
excel_file = r'D:\workspace\project\KG_AI_Project\resource\raw_files\기본통계_이용및이용자.xlsx'

wb = load_workbook(excel_file, read_only=True)
sheet_names = wb.sheetnames

# 컬럼명: 2014~2019
columns_2014_2019 = [
    '번호','학교명','학교유형','설립','지역','대학규모',
    '봉사대상자수-재학생수','봉사대상자수-학부생','봉사대상자수-대학원생','봉사대상자수-전임교원',
    '봉사대상자수-비전임교원','봉사대상자수-직원','봉사대상자수-기타','봉사대상자수-계',
    '학과수','도서관 이용자수',
    '대출자수-학부생','대출자수-대학원생','대출자수-교원','대출자수-직원','대출자수-기타','대출자수-계',
    '대출책수-학부생','대출책수-대학원생','대출책수-교원','대출책수-직원','대출책수-기타','대출책수-계',
    '참고서비스 신청 건수 (2010년 이전)','참고서비스 제공 건수 (2010년 이전)',
    '참고서비스 제공 건수 (2010년 이후)-면담','참고서비스 제공 건수 (2010년 이후)-전화','참고서비스 제공 건수 (2010년 이후)-온라인',
    '상호대차 신청 건수','상호대차 제공 건수','원문복사 신청 건수','원문복사 제공 건수',
    '이용자 교육횟수','이용자 교육 참가자수',
    '대출책수','재학생수','재학생 1인당 대출책수',
    '방문자수','재학생수','재학생 1인당 도서관방문자수'
]

# 컬럼명: 2020
columns_2020 = [
    '번호','학교명','학교유형','설립','지역','대학규모',
    '봉사대상자수-전년도-재학생수','봉사대상자수-전년도-학부생','봉사대상자수-전년도-대학원생','봉사대상자수-전년도-전임교원',
    '봉사대상자수-전년도-비전임교원','봉사대상자수-전년도-직원','봉사대상자수-전년도-기타','봉사대상자수-전년도-계',
    '봉사대상자수-당해년도-재학생수','봉사대상자수-당해년도-학부생','봉사대상자수-당해년도-대학원생','봉사대상자수-당해년도-전임교원',
    '봉사대상자수-당해년도-비전임교원','봉사대상자수-당해년도-직원','봉사대상자수-당해년도-기타','봉사대상자수-당해년도-계',
    '학과수','도서관 이용자수',
    '대출자수-학부생','대출자수-대학원생','대출자수-교원','대출자수-직원','대출자수-기타','대출자수-계',
    '대출책수-학부생','대출책수-대학원생','대출책수-교원','대출책수-직원','대출책수-기타','대출책수-계',
    '참고서비스 신청 건수 (2010년 이전)','참고서비스 제공 건수 (2010년 이전)',
    '참고서비스 제공 건수 (2010년 이후)-면담','참고서비스 제공 건수 (2010년 이후)-전화','참고서비스 제공 건수 (2010년 이후)-온라인',
    '상호대차 신청 건수','상호대차 제공 건수','원문복사 신청 건수','원문복사 제공 건수',
    '이용자 교육횟수','이용자 교육 참가자수',
    '대출책수','재학생수','재학생 1인당 대출책수',
    '방문자수','재학생수','재학생 1인당 도서관방문자수'
]

# 컬럼명: 2021~2024
columns_2021_2024 = [
    '번호','학교명','학교유형','설립','지역','대학규모',
    '봉사대상자수-전년도-재학생수','봉사대상자수-전년도-학부생','봉사대상자수-전년도-대학원생','봉사대상자수-전년도-전임교원',
    '봉사대상자수-전년도-비전임교원','봉사대상자수-전년도-직원','봉사대상자수-전년도-기타','봉사대상자수-전년도-계',
    '봉사대상자수-당해년도-재학생수','봉사대상자수-당해년도-학부생','봉사대상자수-당해년도-대학원생','봉사대상자수-당해년도-전임교원',
    '봉사대상자수-당해년도-비전임교원','봉사대상자수-당해년도-직원','봉사대상자수-당해년도-기타','봉사대상자수-당해년도-계',
    '학과수','도서관 이용자수',
    '대출자수-학부생','대출자수-대학원생','대출자수-교원','대출자수-직원','대출자수-기타','대출자수-계',
    '대출책수-학부생','대출책수-대학원생','대출책수-교원','대출책수-직원','대출책수-기타','대출책수-계',
    '참고서비스 신청 건수 (2010년 이전)','참고서비스 제공 건수 (2010년 이전)',
    '참고서비스 제공 건수 (2010년 이후)-면담','참고서비스 제공 건수 (2010년 이후)-전화','참고서비스 제공 건수 (2010년 이후)-온라인',
    '상호대차 신청 건수','상호대차 제공 건수','원문복사 신청 건수','원문복사 제공 건수',
    '대면-이용자 교육횟수','대면-이용자 교육 참가자수','비대면-이용자 교육횟수','비대면-이용자 교육 참가자수',
    '대출책수','재학생수','재학생 1인당 대출책수',
    '방문자수','재학생수','재학생 1인당 도서관방문자수'
]

# CSV 저장 루틴
for sheet in sheet_names:
    year = int(sheet)

    # 행 오프셋 조건 적용
    if year <= 2019:
        df = pd.read_excel(excel_file, sheet_name=sheet, skiprows=7, header=None, engine='openpyxl')
        columns = columns_2014_2019
    elif year == 2020:
        df = pd.read_excel(excel_file, sheet_name=sheet, skiprows=8, header=None, engine='openpyxl')  # 2020은 9행부터
        columns = columns_2020
    else:
        df = pd.read_excel(excel_file, sheet_name=sheet, skiprows=8, header=None, engine='openpyxl')  # 2021~
        columns = columns_2021_2024

    # 열 슬라이싱 + 연도 삽입
    subset = df.iloc[:, 0:len(columns)]
    subset.insert(0, '연도', year)
    subset.columns = ['연도'] + columns

    # 저장
    filename = f'Num04_이용및이용자_{year}.csv'
    subset.to_csv(filename, index=False, encoding='utf-8-sig')

print("✅ 기본통계_이용및이용자 CSV 저장 완료 (연도별 구조 자동 적용)")
